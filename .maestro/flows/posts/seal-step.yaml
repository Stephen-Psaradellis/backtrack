# Seal Step Test (Moment 3: Seal & Send)
# Tests the photo verification, review, and submit step
#
# Prerequisites:
# - App installed and launched
# - User logged in with test account (has profile photos)

appId: app.backtrack.social
---
# First, ensure we're logged in
- runFlow: ../auth/login.yaml

# Wait for home screen to load
- waitForAnimationToEnd

# Verify we're on the home screen
- extendedWaitUntil:
    visible:
      id: "home-screen"
    timeout: 15000

# Navigate to create post via favorites
- tapOn:
    id: "home-favorites-header"
- waitForAnimationToEnd

# Swipe up to ensure favorites list is visible
- swipe:
    direction: UP
    duration: 500
- waitForAnimationToEnd

# Wait for favorites to load and tap on a favorite card to select it
- extendedWaitUntil:
    visible: "Current Location"
    timeout: 10000

- tapOn: "Current Location"
- waitForAnimationToEnd

# Wait for Post Here button to appear (shown when favorite is selected)
- extendedWaitUntil:
    visible: "Post Here"
    timeout: 10000

- tapOn: "Post Here"
- waitForAnimationToEnd

# ============================================================================
# NAVIGATE THROUGH SCENE AND MOMENT STEPS
# ============================================================================

# Scene step - proceed with preselected location
- extendedWaitUntil:
    visible: "Where & When"
    timeout: 10000

- tapOn:
    id: "create-post-scene-next"
- waitForAnimationToEnd

# Moment step - create avatar and note
- extendedWaitUntil:
    visible: "Who & What"
    timeout: 10000

# Open avatar creator and save
- tapOn:
    id: "create-post-customize-avatar"
- waitForAnimationToEnd

- extendedWaitUntil:
    visible: "Describe Who You Saw"
    timeout: 10000

- tapOn: "Save avatar"
- waitForAnimationToEnd

# Enter note
- extendedWaitUntil:
    visible: "What would you say to them?"
    timeout: 10000

- tapOn:
    id: "create-post-note-input"
- inputText: "Seal step test - I saw you at this location!"
- pressKey: back
- waitForAnimationToEnd

# Proceed to Seal step
- tapOn:
    id: "create-post-moment-next"
- waitForAnimationToEnd

# ============================================================================
# TEST SEAL STEP ELEMENTS
# ============================================================================

# Verify we're on the Seal step
- extendedWaitUntil:
    visible: "Seal & Send"
    timeout: 10000

# Verify review card is visible
- assertVisible: "Review Your Post"

# Verify we can see the message preview
- assertVisible: "Your message"
- assertVisible: "Seal step test"

# Verify location section in review
# (The location name from favorites should be visible)

# Verify photo selection section
- assertVisible: "Verify it's you"
- assertVisible: "Select a verification photo"

# Verify privacy text
- assertVisible: "Your photo is only shown to matches"

# Verify submit button
- assertVisible: "Post Missed Connection"

# ============================================================================
# TEST EDIT NAVIGATION FROM REVIEW CARD
# ============================================================================

# Test tapping on moment section to edit
- tapOn:
    id: "create-post-edit-moment"
- waitForAnimationToEnd

# Verify we're back on Moment step
- extendedWaitUntil:
    visible: "Who & What"
    timeout: 10000

# Go forward again
- tapOn:
    id: "create-post-moment-next"
- waitForAnimationToEnd

# Verify we're back on Seal step
- extendedWaitUntil:
    visible: "Seal & Send"
    timeout: 10000

# Test tapping on scene section to edit
- tapOn:
    id: "create-post-edit-scene"
- waitForAnimationToEnd

# Verify we're back on Scene step
- extendedWaitUntil:
    visible: "Where & When"
    timeout: 10000

# Navigate back to Seal step
- tapOn:
    id: "create-post-scene-next"
- waitForAnimationToEnd

- extendedWaitUntil:
    visible: "Who & What"
    timeout: 10000

- tapOn:
    id: "create-post-moment-next"
- waitForAnimationToEnd

# ============================================================================
# TEST SUBMIT BUTTON STATE
# ============================================================================

# Verify we're back on Seal step
- extendedWaitUntil:
    visible: "Seal & Send"
    timeout: 10000

# The submit button should be visible
# If user has approved photos, one should be auto-selected
- assertVisible: "Post Missed Connection"

# Note: Actual submission would create a post in the database
# For testing, we can just verify the button is present
# Don't tap submit to avoid creating test posts

# ============================================================================
# TEST BACK NAVIGATION
# ============================================================================

# Go back to Moment step
- tapOn:
    id: "create-post-seal-back"
- waitForAnimationToEnd

# Verify we're on Moment step
- extendedWaitUntil:
    visible: "Who & What"
    timeout: 10000

# Verify data preserved
- assertVisible: "Seal step test"
