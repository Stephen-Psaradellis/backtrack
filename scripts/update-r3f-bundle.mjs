#!/usr/bin/env node
/**
 * Update r3fBundle.ts with the built webgl-avatar bundle
 * Run: node scripts/update-r3f-bundle.mjs
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.dirname(__dirname);

const bundlePath = path.join(projectRoot, 'webgl-avatar', 'dist', 'index.html');
const outputPath = path.join(projectRoot, 'components', 'avatar3d', 'r3fBundle.ts');

try {
  // Read the built bundle
  const bundleHtml = fs.readFileSync(bundlePath, 'utf8');

  // Escape backticks and ${} for template literal
  const escapedHtml = bundleHtml
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$\{/g, '\\${');

  // Generate the TypeScript file
  const content = `/**
 * R3F Bundle HTML Content
 *
 * THIS FILE IS AUTO-GENERATED - DO NOT EDIT MANUALLY!
 * Generated by: npm run build:webgl
 *
 * This file contains the bundled React Three Fiber avatar renderer.
 * It includes React, Three.js, React Three Fiber, and @react-three/drei.
 *
 * Bundle size: ~261KB gzipped
 */

export const R3F_BUNDLE_HTML = \`${escapedHtml}\`;
`;

  fs.writeFileSync(outputPath, content);
  console.log(`Updated ${outputPath}`);
  console.log(`Bundle size: ${(bundleHtml.length / 1024).toFixed(2)}KB uncompressed`);
} catch (error) {
  console.error('Error updating r3fBundle.ts:', error.message);
  process.exit(1);
}
